# 4轴全自动赤道仪开发计划书 (CoolEq System)

## 1. 项目概述 (Project Overview)

本项目旨在开发一款 **全集成、自智化** 的天文望远镜机器系统。
与传统“赤道仪+电脑”的分离式方案不同，CoolEq 将 **计算单元 (Brain)** 直接集成在机身内部。用户无需连接电脑或手机即可完成初始化，实现“放置即拍摄”（Place & Shoot）。

核心理念：**彻底接管硬件控制权**。系统内部闭环控制赤道仪运动、相机拍摄与图像解析，实现真正的全自动极轴校准与目标跟踪。
此外，引入 **USB Passthrough** 技术，支持在智能校准完成后将相机硬件无缝移交给外部设备（如 ZWO ASIAIR），实现生态兼容。

---

## 2. 系统架构 (System Architecture)

### 2.1 机械结构设计 (Mechanical)
*   **上层：跟踪层 (Tracking Head)**
    *   **结构**：谐波减速机 (17-100) 直驱，零背隙，高载重自重比。
    *   **电机**：NEMA 17 (0.9°) 高精度步进电机。
*   **下层：校准层 (Alignment Base)**
    *   **结构**：高刚性蜗轮蜗杆/丝杆结构，具备 **自锁能力**。
    *   **功能**：负责 Alt (高度) 和 Az (方位) 的物理调节。
    *   **电机**：NEMA 17/23，专注于大扭矩与自锁。

### 2.2 电子电气架构 (Electronics)
采用 **“双脑架构 + USB Mux”**：

1.  **运动控制核心 (Motion MCU)**:
    *   **硬件**: ESP32 (Fysetc E4)。
    *   **固件**: **OnStepX** (定制版)。
    *   **职责**: 实时脉冲生成、电机驱动、传感器读取、执行底层运动指令。
    *   **接口**: 4路 TMC2209 (RA, Dec, Alt, Az)。

2.  **智慧计算核心 (Smart Host / SBC)**:
    *   **硬件**: **Raspberry Pi 4/5** 或 **Orange Pi** (Linux 环境)。
    *   **软件**: INDI Server + CoolEq Daemon (Python/C++) + ASTAP (板解析)。
    *   **职责**: 视觉中枢、逻辑中枢、交互中枢。

3.  **USB 链路控制 (USB Mux/Passthrough)**:
    *   **芯片**: **TI HD3SS3212** (或同类 USB 3.0 Mux)。
    *   **功能**: 切换相机数据流向。
        *   **Local Mode**: 相机 -> 树莓派 (用于自动校准)。
        *   **Passthrough Mode**: 相机 -> 外部 USB 口 (给 ASIAIR 使用)。

### 2.3 软件生态 (Software Stack)
*   **底层 (Firmware)**: OnStepX。
*   **中层 (Middleware)**: CoolEq Daemon。
*   **上层 (Interface)**: 手机 APP / 网页端。

---

## 3. 核心功能实现方案：全自动闭环与生态兼容

### 3.1 全自动极轴校准 (Auto Mechanical PA)
用户操作：**开机 -> 点击“自动校准”**。
1.  **归位与粗对**: MCU 驱动底座粗略指向。
2.  **视觉采样**: SBC 控制相机拍照 -> 解析 -> 发送 Sync 指令 (3点采样)。
3.  **误差解算与修正**: MCU 计算极轴误差 -> 驱动 Axis3/4 物理修正 -> 清除模型。
4.  **验证**: 确认误差 < 1 角分。

### 3.2 智能移交 (Smart Handover)
校准完成后，用户可选择 **“移交控制权 (Handover to ASIAIR)”**：
1.  树莓派停止 INDI Server，释放相机占用。
2.  树莓派 GPIO 触发 USB Mux 芯片切换。
3.  相机数据流直接透传至外部 USB Type-B/C 接口。
4.  用户连接 ASIAIR，即可像使用普通赤道仪一样接管拍摄。

---

## 4. 开发阶段规划 (Roadmap)

### 阶段一：运动底盘 (Motion Chassis) - 3周
*   组装谐波赤道仪 + 电动底座，调试 OnStepX 4轴驱动。

### 阶段二：智慧大脑与 USB Mux (Brain & Mux) - 5周
*   **新增任务**:
    1.  设计包含 HD3SS3212 的 USB 3.0 切换 PCB (或采购成品模块改造)。
    2.  编写 GPIO 控制脚本，测试 USB 3.0 信号在切换后的完整性（不掉速、不丢帧）。
    3.  联调 "拍照-解析-同步" 链路。

### 阶段三：全自动算法 (Automation) - 3周
*   编写状态机逻辑，整合 USB 切换流程。

---

## 5. 物料清单估算 (BOM Estimation)

| 组件 | 规格推荐 | 预估成本 (CNY) | 备注 |
| :--- | :--- | :--- | :--- |
| **计算单元** | Raspberry Pi 4B / 5 (4GB) | 400 - 600 | 系统的“大脑” |
| **主控板** | Fysetc E4 (ESP32) | 150 | 系统的“小脑” |
| **USB Mux** | HD3SS3212 模块/自制 PCB | 50 - 100 | **新增：USB 切换核心** |
| **RA/DEC 减速机** | 谐波减速机 (二手/国产) x2 | 1200 - 2000 | 核心成本 |
| **Alt/Az 结构** | 涡轮蜗杆+铝合金加工 | 500 - 800 | 需高刚性 |
| **步进电机** | NEMA 17 (0.9deg) x4 | 200 | |
| **传感器** | GPS + MPU6050 | 50 | |
| **总计** | | **~3100 - 4100** | 增加 USB Mux 成本 |

---

## 6. 风险评估

1.  **USB 3.0 信号完整性**: Mux 芯片对 PCB 布线要求极高（差分阻抗、等长）。
    *   *对策*: 优先寻找成品 USB 3.0 Switch 模块进行改装，或者仅使用 USB 2.0 (对于导星/解析足够，但对深空拍摄稍慢)。
2.  **系统供电**: 树莓派 + ESP32 + 4个电机 + 相机制冷，功耗较大。
    *   *对策*: 设计专用的 12V 转 5V (5A+) 电源管理模块 (PMU)。
