# 4轴全自动赤道仪开发计划书 (基于 OnStepX)

## 1. 项目概述 (Project Overview)

本项目旨在开发一款具备 **“零介入”** 设置能力的天文望远镜支架系统。通过增加电动 Alt/Az 底座，结合机器视觉（板解析），实现从开机到开始拍摄的全流程自动化：自动寻北/定位 -> 自动极轴校准 -> 自动 GOTO 目标 -> 自动跟踪/导星。

**核心变更**：本项目将采用 **OnStepX** 固件作为核心控制器，利用其原生的多轴支持（Native Multi-Axis Support）和优化的 ESP32 架构来实现 4 轴协同控制。

---

## 2. 系统架构 (System Architecture)

### 2.1 机械结构设计 (Mechanical)

系统机械部分分为上下两层：
*   **上层：跟踪层 (Tracking Head)**
    *   **结构**：推荐采用 **谐波减速机 (Harmonic Drive)** 方案（如 17-100 型号）。
    *   **优势**：无需重锤平衡，大扭矩，零背隙，自重轻，适合携带。
    *   **电机**：NEMA 17 (42步进电机) 高精度 0.9° 步进角。
*   **下层：校准层 (Alignment Base)**
    *   **结构**：**大减速比蜗轮蜗杆 (Worm Gear)** 或 丝杆推杆结构。
    *   **要求**：必须具备**自锁能力**。在极轴对准完成后，电机断电或保持力矩时，底座不可因重力或风力发生微小位移。
    *   **电机**：NEMA 17 或 NEMA 23，追求高扭矩而非高速度。

### 2.2 电子电气架构 (Electronics)

*   **主控核心**：**ESP32-DevKitC** (双核 240MHz, 内置 WiFi/BT)。OnStepX 对 ESP32 进行了深度优化。
*   **驱动主板**：推荐 **Fysetc E4** (集成4路 TMC2209 驱动的3D打印主板)。
    *   *Axis 1 (RA)*: TMC2209 UART (OnStepX Native RA)
    *   *Axis 2 (DEC)*: TMC2209 UART (OnStepX Native DEC)
    *   *Axis 3 (Alt)*: TMC2209 UART (配置为 OnStepX AXIS3 / Aux1)
    *   *Axis 4 (Az)*: TMC2209 UART (配置为 OnStepX AXIS4 / Aux2)
*   **传感器**：
    *   **GPS 模块** (BN-220)：自动获取经纬度和授时。
    *   **IMU** (MPU6050/BNO055)：提供初始水平和俯仰数据，辅助粗对准。
    *   **霍尔传感器/限位开关**：用于各轴的复位（Home）。

### 2.3 软件生态 (Software Stack)

*   **固件 (Firmware)**：**OnStepX** (Beta/Master 分支)。
    *   *优势*：相比老版 OnStep，OnStepX 在 `Config.h` 中原生支持将任意轴映射为辅助功能，配置更灵活；内置新版 **SWS (Smart Web Server)**，提供更现代化的 Web 控制界面。
*   **驱动 (Driver)**：ASCOM (Windows) / INDI (Linux/Raspberry Pi)。
    *   需配置 ASCOM 驱动将 Aux1/Aux2 映射为 Alt/Az 控制接口，或使用 OnStepX 的 Custom Command 功能。
*   **上位机 (Client)**：N.I.N.A. (推荐) 或 KStars/Ekos。
    *   利用其 "Three Point Polar Alignment" 插件计算误差。
    *   *注意*：OnStepX 负责执行运动，板解析和误差计算逻辑由上位机完成。

---

## 3. 核心功能实现方案

### 3.1 全自动极轴对准 (Auto Polar Alignment) 逻辑

这是本项目的核心难点，流程如下：
1.  **粗对准**：利用 GPS 和 IMU 数据，OnStepX 驱动 Alt/Az 电机将望远镜大概指向正北（需磁偏角修正）和当地纬度仰角。
2.  **板解析采样**：
    *   上位机控制相机拍摄天区 -> 识别星点 -> 计算当前指向 (RA1, DEC1)。
    *   上位机指令 RA 轴旋转 30度 -> 再次拍摄 -> 计算指向 (RA2, DEC2)。
3.  **误差解算**：
    *   上位机通过两次指向计算出机械旋转轴中心。
    *   对比机械轴中心与天球北极（NCP）的偏差矢量 $(\Delta Alt, \Delta Az)$。
4.  **闭环修正**：
    *   上位机将角度偏差转换为 Alt/Az 电机的脉冲数。
    *   通过 ASCOM/INDI 发送指令给 OnStepX 的 AXIS3/AXIS4。
    *   驱动电机修正，并重复上述过程直到误差 < 1 角分。

### 3.2 GOTO 与 跟踪
*   **GOTO**：OnStepX 固件内置星库和坐标转换算法，直接发送 J2000 坐标即可。
*   **跟踪**：启动恒星时（Sidereal Rate）脉冲发生器。支持脉冲导星（Pulse Guiding）。

---

## 4. 开发阶段规划 (Roadmap)

### 阶段一：核心跟踪单元 (预计 2-3 周)
*   **目标**：完成 RA/DEC 双轴的组装与 OnStepX 基础配置。
*   **任务**：
    1.  采购 ESP32、TMC2209、步进电机。
    2.  刷入 **OnStepX** 固件，在 `Config.h` 中配置 RA/DEC 齿轮比和电机参数。
    3.  验证 SWS Web 界面连接与控制。
    4.  验证 ASCOM 连接，测试 GOTO 精度与恒星时跟踪。

### 阶段二：自动底座开发 (预计 3-4 周)
*   **目标**：完成 Alt/Az 机械结构与 OnStepX 辅助轴驱动。
*   **任务**：
    1.  设计并加工蜗轮蜗杆底座（需保证高刚性）。
    2.  连接第3、4路电机驱动。
    3.  修改 OnStepX 配置，启用 `AXIS3` (Alt) 和 `AXIS4` (Az)，并映射为辅助轴。
    4.  编写简单的 Python 脚本或使用 ASCOM Console，发送指令测试底座移动。

### 阶段三：算法集成与联调 (预计 2 周)
*   **目标**：实现全自动化流程。
*   **任务**：
    1.  配置 N.I.N.A. 的极轴校准插件。
    2.  实地测试：从粗对准到精对准的闭环测试。
    3.  优化电机速度曲线（S-Curve），防止校准时的震动影响极轴精度。

---

## 5. 物料清单估算 (BOM Estimation)

| 组件 | 规格推荐 | 预估成本 (CNY) | 备注 |
| :--- | :--- | :--- | :--- |
| **主控板** | Fysetc E4 (ESP32) | 150 | OnStepX 官方推荐板卡之一 |
| **RA/DEC 减速机** | 谐波减速机 (二手/国产) x2 | 1200 - 2000 | 核心成本，决定跟踪精度 |
| **Alt/Az 结构** | 涡轮蜗杆+铝合金加工 | 500 - 800 | 需定制加工或购买现成微调台改装 |
| **步进电机** | NEMA 17 (0.9deg) x4 | 200 | 推荐雷赛或信浓 |
| **传感器** | GPS + MPU6050 | 50 | OnStepX 原生支持 |
| **其他** | 轴承、同步带、螺丝、外壳 | 300 | |
| **总计** | | **~2500 - 3500** | 不含相机和望远镜本体 |

---

## 6. 风险评估

1.  **线缆缠绕 (Cable Snag)**：4轴全动可能导致线缆缠绕。
    *   *对策*：设计滑环（Slip Ring）或严格的线缆管理卡扣。
2.  **底座刚性**：Alt/Az 如果锁不紧，长曝光会拖线。
    *   *对策*：Alt/Az 尽量使用大减速比（>100:1）的涡轮蜗杆，利用机械自锁特性。
3.  **软件闭环延迟**：N.I.N.A. 计算误差后发送指令给 OnStepX 是否有延迟或单位换算错误。
    *   *对策*：在开发阶段二仔细校准 Steps Per Degree 参数。
